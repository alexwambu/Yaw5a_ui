<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Yaw5a Control Panel</title>
  <style>
    :root {
      --bg:#0f1724;
      --card:#0b1220;
      --muted:#9aa4b2;
      --accent:#4f46e5;
      --text:#e6eef6;
    }
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui}
    body{margin:0;background:linear-gradient(180deg,#071029 0%, #071020 100%);color:var(--text);min-height:100vh}
    .app{max-width:1100px;margin:28px auto;padding:18px}
    .header{display:flex;flex-direction:column;gap:6px;margin-bottom:18px}
    .header h1{margin:0;font-size:22px}
    .sub{color:var(--muted);font-size:13px;margin:0}
    .main{display:grid;grid-template-columns:1fr 420px;gap:18px}
    .card{background:rgba(255,255,255,0.02);padding:14px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.6)}
    .footer{margin-top:18px;color:var(--muted);font-size:13px}
    .list{list-style:none;padding:0;margin:0}
    .list-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.01)}
    .controls button{padding:6px 10px;border-radius:8px;border:0;background:var(--accent);color:white;cursor:pointer}
    .form-row{display:flex;flex-direction:column;margin-bottom:8px}
    .form-row label{font-size:13px;color:var(--muted);margin-bottom:6px}
    input,textarea{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:var(--text);width:100%}
    .form-actions{display:flex;gap:8px;margin-top:8px}
    button{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:white;cursor:pointer}
    .muted{color:var(--muted);font-size:12px}
  </style>
</head>
<body>
<div class="app">
  <header class="header">
    <h1>Yaw5a Control Panel</h1>
    <p class="sub">Connected to: <span id="api-base"></span></p>
  </header>

  <main class="main">
    <!-- Jobs -->
    <div class="card">
      <h2>Jobs</h2>
      <div style="margin-bottom:12px">
        <input id="new-job" placeholder="New job title"/>
        <button onclick="createJob()">Create</button>
        <button onclick="loadJobs()" style="margin-left:8px">Refresh</button>
        <button onclick="testCreateJob()" style="margin-left:8px">Test Job</button>
      </div>
      <ul id="job-list" class="list"></ul>
    </div>

    <!-- Movie Worker -->
    <div class="card">
      <h2>Movie Worker</h2>
      <div class="form-row">
        <label>Script name</label>
        <input id="script" value="movie.py"/>
      </div>
      <div class="form-row">
        <label>Params (JSON)</label>
        <textarea id="params" rows="4">{}</textarea>
      </div>
      <div class="form-actions">
        <button onclick="runMovie()">Run Movie</button>
        <button onclick="expandWorker()">Expand Worker</button>
        <button onclick="testMovieWorker()">Test Movie</button>
      </div>
      <hr/>
      <div>
        <label>Speech synthesis</label>
        <input id="speech-text" placeholder="Text to synthesize"/>
        <button onclick="synthesize()">Synthesize</button>
        <button onclick="testSpeech()">Test Speech</button>
      </div>
      <div style="margin-top:12px">
        <strong>Status:</strong> <span id="status"></span>
      </div>
    </div>
  </main>

  <footer class="footer">
    <small>Deploy-ready UI — connects to your Render backend.</small>
  </footer>
</div>

<script>
  const API_BASE = "https://yaw5a.onrender.com";
  document.getElementById("api-base").textContent = API_BASE;

  async function request(path, opts={}) {
    const res = await fetch(API_BASE + path, {
      headers: {"Content-Type":"application/json"},
      ...opts
    });
    if (!res.ok) throw new Error("HTTP " + res.status + ": " + await res.text());
    return res.json().catch(() => ({}));
  }

  /* ---------- JOBS ---------- */
  async function loadJobs(){
    const list = document.getElementById("job-list");
    list.innerHTML = "<li>Loading...</li>";
    try {
      const jobs = await request("/jobs");
      list.innerHTML = "";
      if(!jobs || jobs.length===0){
        list.innerHTML = "<li>No jobs found.</li>";
        return;
      }
      jobs.forEach(job=>{
        const li=document.createElement("li");
        li.className="list-item";
        li.innerHTML=`
          <div>
            <strong>${job.title||job.id}</strong>
            <div class="muted">id: ${job.id}</div>
          </div>
          <div class="controls">
            <button>${job.active?"Disable":"Enable"}</button>
          </div>
        `;
        li.querySelector("button").onclick=async()=>{
          try{
            await request("/jobs/"+encodeURIComponent(job.id),{
              method:"PUT",
              body:JSON.stringify({...job,active:!job.active})
            });
            loadJobs();
          }catch(e){alert("Update failed: "+e.message);}
        };
        list.appendChild(li);
      });
    }catch(e){
      list.innerHTML = "<li>Error: "+e.message+"</li>";
    }
  }

  async function createJob(){
    const title=document.getElementById("new-job").value.trim();
    if(!title) return alert("Enter title");
    try{
      await request("/jobs",{method:"POST",body:JSON.stringify({title,active:true})});
      document.getElementById("new-job").value="";
      loadJobs();
    }catch(e){alert("Create failed: "+e.message);}
  }

  // Test script: create sample job
  async function testCreateJob(){
    try{
      const res=await request("/jobs",{method:"POST",body:JSON.stringify({title:"Sample Job from yaw5a_ui",active:true})});
      alert("Created sample job: "+JSON.stringify(res));
      loadJobs();
    }catch(e){alert("Test job failed: "+e.message);}
  }

  /* ---------- MOVIE WORKER ---------- */
  async function runMovie(){
    setStatus("running");
    try{
      const script=document.getElementById("script").value;
      const params=JSON.parse(document.getElementById("params").value||"{}");
      const res=await request("/worker/run-movie",{method:"POST",body:JSON.stringify({script,params})});
      setStatus("ok: "+(res.message||JSON.stringify(res)));
    }catch(e){setStatus("error: "+e.message);}
  }

  async function expandWorker(){
    setStatus("expanding");
    try{
      const res=await request("/worker/expand",{method:"POST",body:JSON.stringify({workers:1,options:{}})});
      setStatus("expanded: "+(res.message||JSON.stringify(res)));
    }catch(e){setStatus("error: "+e.message);}
  }

  // Test script: run default movie.py with sample params
  async function testMovieWorker(){
    setStatus("running test script");
    try{
      const res=await request("/worker/run-movie",{method:"POST",body:JSON.stringify({script:"movie.py",params:{characters:3,duration:"2m",autoEdit:true}})});
      setStatus("Movie worker test → "+(res.message||JSON.stringify(res)));
    }catch(e){setStatus("Test movie error: "+e.message);}
  }

  /* ---------- SPEECH ---------- */
  async function synthesize(){
    const text=document.getElementById("speech-text").value;
    try{
      const res=await request("/speech/synthesize",{method:"POST",body:JSON.stringify({text})});
      setStatus("speech: "+(res.url||res.message||"ok"));
    }catch(e){setStatus("speech error: "+e.message);}
  }

  // Test script: synthesize sample text
  async function testSpeech(){
    try{
      const res=await request("/speech/synthesize",{method:"POST",body:JSON.stringify({text:"Hello from yaw5a_ui frontend"})});
      setStatus("Speech test → "+(res.url||res.message||"ok"));
    }catch(e){setStatus("Speech test error: "+e.message);}
  }

  function setStatus(msg){document.getElementById("status").textContent=msg;}

  // Auto-load jobs
  loadJobs();
</script>
</body>
</html>
